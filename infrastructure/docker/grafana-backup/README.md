# Grafana Dashboard Backup Docker Image

Custom Docker image for automated Grafana dashboard export and Git version control with auto-commit functionality.

## Overview

- **Base Image**: Alpine Linux 3.19
- **Purpose**: Daily Grafana dashboard backup automation
- **Storage**: Git repository with version history
- **Features**: Auto-commit, datasource export, metadata tracking

## Build

```bash
cd infrastructure/docker/grafana-backup
docker build -t health-tracker/grafana-backup:1.0.0 .
```

## Features

- **Dashboard Export**: Uses Grafana HTTP API to export all dashboards as JSON
- **Git Integration**: Clones repository, commits dashboard changes, pushes to remote
- **Datasource Export**: Exports datasource configuration for provisioning
- **Metadata Tracking**: Creates backup metadata with timestamp and dashboard count
- **SSH Authentication**: Supports SSH keys for Git authentication
- **Change Detection**: Only commits when dashboards have changed

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GRAFANA_URL` | `http://grafana.observability.svc.cluster.local:3000` | Grafana server URL |
| `GRAFANA_API_KEY` | - | Grafana API key (required) |
| `GIT_REPO_URL` | - | Git repository URL (required) |
| `GIT_BRANCH` | `main` | Git branch to commit to |
| `GIT_AUTHOR_NAME` | `Grafana Backup Bot` | Git commit author name |
| `GIT_AUTHOR_EMAIL` | `grafana-backup@health-tracker.local` | Git commit author email |
| `DASHBOARD_DIR` | `.github/dashboards` | Directory for dashboard JSON files |
| `SSH_KEY_PATH` | `/secrets/ssh/id_rsa` | Path to SSH private key |

## Backup Workflow

1. **Validate Configuration**: Check required environment variables
2. **Setup Git**: Configure user and SSH authentication
3. **Clone Repository**: Clone or update local copy of Git repository
4. **Export Dashboards**: Fetch all dashboards from Grafana API and save as JSON
5. **Export Datasources**: Export datasource configuration for provisioning
6. **Create Metadata**: Generate backup metadata with timestamp
7. **Commit Changes**: Create Git commit if dashboards changed
8. **Push Changes**: Push commits to remote repository

## Grafana API Integration

The backup script uses the following Grafana API endpoints:

- `GET /api/search?type=dash-db` - List all dashboards
- `GET /api/dashboards/uid/{uid}` - Export individual dashboard
- `GET /api/datasources` - List all datasources

## Git Repository Structure

After backup, the repository contains:

```
repository-root/
â””â”€â”€ .github/
    â””â”€â”€ dashboards/
        â”œâ”€â”€ executive-dashboard.json
        â”œâ”€â”€ operations-dashboard.json
        â”œâ”€â”€ development-dashboard.json
        â”œâ”€â”€ cost-dashboard.json
        â”œâ”€â”€ backup-metadata.json
        â””â”€â”€ provisioning/
            â””â”€â”€ datasources.yml
```

## Dashboard JSON Format

Each dashboard is saved with sanitized filename:

```bash
# Original title: "Executive Dashboard"
# Saved as: executive-dashboard.json

# Original title: "CI/CD Operations View"
# Saved as: ci-cd-operations-view.json
```

## Metadata Format

The `backup-metadata.json` file contains:

```json
{
  "timestamp": "2025-01-22T03:00:00Z",
  "grafana_url": "http://grafana.observability.svc.cluster.local:3000",
  "dashboard_count": 4,
  "backup_version": "1.0.0",
  "git_branch": "main"
}
```

## Git Commit Message Format

```
chore(dashboards): automated Grafana dashboard backup

Backed up 4 dashboard(s) from Grafana

Timestamp: 2025-01-22 03:00:00 UTC
Grafana URL: http://grafana.observability.svc.cluster.local:3000

ðŸ¤– Generated by Grafana Backup Bot
```

## Authentication

### Grafana API Key

Create an API key in Grafana with Viewer role:

1. Navigate to **Configuration** > **API Keys**
2. Click **Add API Key**
3. Name: `dashboard-backup-bot`
4. Role: **Viewer** (read-only access)
5. Time to live: No expiration (or set long duration)
6. Click **Add**
7. Copy the generated key

### Git SSH Authentication

Generate SSH key pair for Git authentication:

```bash
ssh-keygen -t rsa -b 4096 \
  -C "grafana-backup@health-tracker.local" \
  -f grafana-backup-key \
  -N ""
```

Add the public key to your Git repository:

- **GitHub**: Settings > Deploy keys > Add deploy key
- **GitLab**: Settings > Repository > Deploy keys > Add key
- **Bitbucket**: Repository settings > Access keys > Add key

## Testing

### Local Testing

```bash
# Set required environment variables
export GRAFANA_URL="http://localhost:3000"
export GRAFANA_API_KEY="your-api-key"
export GIT_REPO_URL="git@github.com:your-org/health-tracker.git"

# Create SSH key secret
mkdir -p /tmp/ssh-secrets
cp ~/.ssh/id_rsa /tmp/ssh-secrets/

# Run backup
docker run --rm \
  -e GRAFANA_URL \
  -e GRAFANA_API_KEY \
  -e GIT_REPO_URL \
  -v /tmp/ssh-secrets:/secrets/ssh:ro \
  health-tracker/grafana-backup:1.0.0
```

### Test Grafana API Access

```bash
# Test authentication
curl -H "Authorization: Bearer YOUR_API_KEY" \
  http://localhost:3000/api/search?type=dash-db

# Expected: JSON array of dashboards
```

### Test Dashboard Export

```bash
# Get dashboard UID from search results
DASHBOARD_UID="abc123"

# Export dashboard
curl -H "Authorization: Bearer YOUR_API_KEY" \
  http://localhost:3000/api/dashboards/uid/$DASHBOARD_UID

# Expected: JSON with dashboard definition
```

## Security

- **Non-root User**: Runs as UID 65534 (nobody)
- **Read-only Filesystem**: Minimal write access (workspace only)
- **Secret Management**: API keys and SSH keys from Kubernetes secrets
- **SSH Key Cleanup**: Removes SSH keys from memory after use
- **No Privileged Access**: Drops all capabilities

## Monitoring

The backup job logs all operations:

```
[2025-01-22 03:00:00] === Grafana Dashboard Backup Started ===
[2025-01-22 03:00:00] Grafana URL: http://grafana.observability.svc.cluster.local:3000
[2025-01-22 03:00:00] Git Repository: git@github.com:your-org/health-tracker.git
[2025-01-22 03:00:00] Git Branch: main
[2025-01-22 03:00:00] Dashboard Directory: .github/dashboards
[2025-01-22 03:00:00] Validating configuration...
[2025-01-22 03:00:00] Configuration validated
[2025-01-22 03:00:01] Setting up Git configuration...
[2025-01-22 03:00:01] SSH configured
[2025-01-22 03:00:01] Git configuration complete
[2025-01-22 03:00:01] Cloning repository: git@github.com:your-org/health-tracker.git
[2025-01-22 03:00:05] Repository ready
[2025-01-22 03:00:05] Starting dashboard export...
[2025-01-22 03:00:05] Fetching dashboard list from Grafana...
[2025-01-22 03:00:06] Found 4 dashboard(s)
[2025-01-22 03:00:06] Exporting dashboard: Executive Dashboard (uid: exec-dash-001)
[2025-01-22 03:00:06] Dashboard exported: executive-dashboard.json
[2025-01-22 03:00:07] Exporting dashboard: Operations Dashboard (uid: ops-dash-001)
[2025-01-22 03:00:07] Dashboard exported: operations-dashboard.json
[2025-01-22 03:00:08] Exporting dashboard: Development Dashboard (uid: dev-dash-001)
[2025-01-22 03:00:08] Dashboard exported: development-dashboard.json
[2025-01-22 03:00:09] Exporting dashboard: Cost Dashboard (uid: cost-dash-001)
[2025-01-22 03:00:09] Dashboard exported: cost-dashboard.json
[2025-01-22 03:00:09] Exported 4 dashboard(s)
[2025-01-22 03:00:09] Exporting datasource configuration...
[2025-01-22 03:00:10] Exported 3 datasource(s)
[2025-01-22 03:00:10] Creating backup metadata...
[2025-01-22 03:00:10] Metadata created
[2025-01-22 03:00:10] Checking for changes...
[2025-01-22 03:00:10] Changes committed
[2025-01-22 03:00:10] Pushing changes to remote...
[2025-01-22 03:00:15] Changes pushed successfully
[2025-01-22 03:00:15] Cleaning up...
[2025-01-22 03:00:15] Cleanup complete
[2025-01-22 03:00:15] === Grafana Dashboard Backup Completed Successfully ===
```

## Troubleshooting

### Grafana API Access Denied

```bash
# Verify API key is valid
curl -H "Authorization: Bearer $GRAFANA_API_KEY" \
  http://grafana.observability.svc.cluster.local:3000/api/org

# Should return organization details
```

### SSH Authentication Failed

```bash
# Test SSH key
ssh -T git@github.com -i /path/to/id_rsa

# Should return: Hi username! You've successfully authenticated
```

### No Dashboards Found

```bash
# Check Grafana has dashboards
curl -H "Authorization: Bearer $GRAFANA_API_KEY" \
  http://grafana.observability.svc.cluster.local:3000/api/search

# Should return non-empty array
```

### Git Push Rejected

```bash
# Verify branch exists
git ls-remote git@github.com:your-org/health-tracker.git

# Verify SSH key has write access
# GitHub: Deploy key must have "Allow write access" enabled
```

## Best Practices

1. **API Key Rotation**: Rotate Grafana API keys every 90 days
2. **SSH Key Security**: Use deploy keys with minimal permissions (read + write to specific repo)
3. **Branch Protection**: Use a dedicated backup branch instead of main
4. **Version Control**: Keep dashboard backups in same repository as infrastructure code
5. **Change Review**: Setup GitHub Actions to notify team of dashboard changes
6. **Backup Verification**: Periodically test dashboard restoration

## Integration with CI/CD

Example GitHub Action to restore dashboards:

```yaml
name: Restore Grafana Dashboards
on:
  workflow_dispatch:
    inputs:
      dashboard:
        description: 'Dashboard to restore (filename)'
        required: true

jobs:
  restore:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Restore Dashboard
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $GRAFANA_API_KEY" \
            -H "Content-Type: application/json" \
            -d @.github/dashboards/${{ inputs.dashboard }} \
            $GRAFANA_URL/api/dashboards/db
```

## References

- [Grafana HTTP API](https://grafana.com/docs/grafana/latest/developers/http_api/)
- [Grafana Dashboard Provisioning](https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards)
- [Git Automation Best Practices](https://git-scm.com/book/en/v2/Git-Branching-Branch-Management)
